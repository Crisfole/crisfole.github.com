<!doctype html>
<html class="no-js" lang="">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/3.0.3/normalize.min.css">
</head>
<body>
  <button id=start>Start Stream</button>
  <hr />
  <video id='video' autoplay muted playsinline />
  <hr/>
  <img id='image' src='https://picsum.photos/200/300' />
  <button id=capture>Capture</button>
  <script>
    function async setupButtonHandler() {
      
      try {
        navigator.mediaDevices.enumerateDevices().then(devices => {

          const cameras = devices.filter((device) => device.kind === 'videoinput');

          if (cameras.length === 0) {
            throw 'No camera found on this device.';
          }
          const camera = cameras[cameras.length - 1];

          // Create stream and get video track
          navigator.mediaDevices.getUserMedia({
            video: {
              deviceId: camera.deviceId,
              facingMode: ['user', 'environment'],
              height: { ideal: 1080 },
              width: { ideal: 1920 }
            },
            audio: false,
          }).then(stream => {
            const track = stream.getVideoTracks()[0];

            //Create image capture object and get camera capabilities
            const imageCapture = new ImageCapture(track)
            const photoCapabilities = imageCapture.getPhotoCapabilities().then(() => {

              //todo: check if camera has a torch

              //let there be light!
              const btn = document.getElementsByTagName('button')[0];
              btn.addEventListener('click', function () {
                track.applyConstraints({ advanced: [{ torch: true }] })
                  .catch(e => {
                    btn.remove();
                    document.body.appendChild(createWarning(e));
                  });
              });
            });
          });
        });
      } catch(e) {
        document.getElementsByTagName('button')[0].remove();
        document.body.appendChild(createWarning(e));
      }
    }

    const startButton = document.getElementById('start');
    const captureButton = document.getElementById('capture');
    const videoElement = document.getElementById('video');
    const imgElement = document.getElementById('image');

    startButton.addEventHandler('click', async evt => {
      startButton.disabled = true;

      const stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: ['user', 'environment'],
              height: { ideal: 1080 },
              width: { ideal: 1920 }
            },
            audio: false,
          });
      videoElement.srcObject = stream;
    });
  </script>
</body>
</html>
